<!DOCTYPE html>
<html lang="en">
<head>
    <title>Empire Command</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: radial-gradient(circle at center, #1a1a1a 0%, #000000 100%); color: white; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 500px; position: relative; z-index: 1; }
        .invites-wrapper { width: 100%; margin-bottom: 20px; display: none; }
        .invite-card { background: linear-gradient(135deg, #330000 0%, #000 100%); border: 2px solid #ff4444; border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: center; box-shadow: 0 0 15px rgba(255, 0, 0, 0.5); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0.4); } 50% { box-shadow: 0 0 0 10px rgba(255, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 68, 68, 0); } }
        .profile-card { background: rgba(30,30,30,0.95); padding: 20px; border-radius: 8px; border: 1px solid #C5A059; display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .avatar { font-size: 3rem; border: 2px solid #C5A059; border-radius: 50%; padding: 10px; width: 60px; height: 60px; display: flex; justify-content: center; align-items: center; background: #000; }
        .user-info h1 { margin: 0; font-family: 'Cinzel', serif; color: #C5A059; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .stat-box { background: rgba(20,20,20,0.8); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid #444; }
        .clickable-stat { cursor: pointer; border: 1px solid #00e676; }
        .stat-val { font-size: 1.3rem; font-weight: bold; color: #00e676; }
        .points-card { grid-column: span 2; border: 1px solid #FFD700; background: linear-gradient(90deg, #222 0%, #333 100%); cursor: pointer; transition: transform 0.1s; }
        .points-card:active { transform: scale(0.98); }
        .points-header { color: #FFD700; font-family: 'Cinzel', serif; margin-bottom: 5px; }
        .clan-section { background: #111; padding: 25px; border: 1px solid #554422; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .btn-manage { background: #8B0000; color: white; width: 100%; padding: 15px; border: 1px solid #ff4444; cursor: pointer; font-family: 'Cinzel', serif; font-weight: bold; }
        .btn-play { width: 100%; padding: 20px; background: linear-gradient(180deg, #D4AF37 0%, #AA8A26 100%); color: #220; border: 1px solid #FFD700; font-family: 'Cinzel', serif; font-weight: bold; font-size: 1.3rem; cursor: pointer; margin-top: 10px; }
        .btn-nav { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: #aaa; margin-bottom: 10px; cursor: pointer; border-radius: 4px; font-weight: bold; }
        .btn-nav:hover { background: #333; color: white; border-color: #666; }
        .btn-war-nav { border-color: #ff4444; color: #ff4444; background: rgba(255, 68, 68, 0.05); }
        .btn-accept-sm { background: #00e676; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-right: 10px; }
        .btn-decline-sm { background: #333; border: 1px solid #ff4444; color:#ff4444; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <div id="invitesPanel" class="invites-wrapper"></div>
    <div class="profile-card">
        <div class="avatar" id="displayIcon">...</div>
        <div class="user-info"><h1 id="displayName">...</h1><p id="statusText">Loading...</p></div>
    </div>
    <div class="stats-grid">
        <div class="stat-box points-card" onclick="window.showStreakDetails()">
            <div class="points-header">CREDIT POINTS</div>
            <span class="stat-val" id="creditPoints" style="color:#FFD700">0</span>
            <div style="font-size:0.7rem; color:#aaa; margin-top:5px;">(Click for Streak Info)</div>
        </div>
        <div class="stat-box clickable-stat" onclick="window.location.href='personal_land.html'">
            <span class="stat-val" id="myArea">0 m¬≤</span><div style="font-size:0.7rem; color:#888;">Personal Land (View)</div>
        </div>
        <div class="stat-box" style="border-color: #8B0000;">
            <span class="stat-val" id="clanArea" style="color:#ff4444">---</span><div style="font-size:0.7rem; color:#888;">Clan Empire</div>
        </div>
    </div>

    <button onclick="window.location.href='personal_war.html'" class="btn-nav btn-war-nav">‚öîÔ∏è Personal War Records</button>
    <button onclick="window.location.href='clan_wars.html'" class="btn-nav btn-war-nav">üõ°Ô∏è Clan War Room</button>
    <button onclick="window.location.href='personal_land.html'" class="btn-nav">üõ°Ô∏è Manage Guards & Lands</button>
    <button onclick="window.location.href='leaderboard.html'" class="btn-nav">üèÜ View Global Leaderboards</button>

    <div id="clanControlPanel" class="clan-section" style="display:none;">
        <h3 id="myClanName" style="color:#C5A059; margin:0 0 10px 0; font-family:'Cinzel', serif;"></h3>
        <button onclick="window.location.href='clan_manage.html'" class="btn-manage">üèõÔ∏è Enter Stronghold</button>
    </div>

    <div id="noClanPanel" class="clan-section" style="display:none;">
        <h3 style="color:#aaa; font-family:'Cinzel', serif; margin:0 0 10px 0;">Join the Fray</h3>
        <input type="text" id="newClanInput" placeholder="New Clan Name" style="padding:10px; width:60%; background:#222; border:1px solid #555; color:white;">
        <button id="createBtn" style="padding:10px; background:#C5A059; border:none; font-weight:bold; cursor:pointer;">Create</button>
    </div>

    <button onclick="window.location.href='game.html'" class="btn-play">‚öîÔ∏è March to War</button>
    <div style="text-align:center; margin-top:30px; text-decoration:underline; cursor:pointer; color:#666;" onclick="logout()">Abandon Post (Logout)</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, update, onValue, get, child, set } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    const firebaseConfig = { databaseURL: "https://runmate-cb328-default-rtdb.firebaseio.com/" };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const currentUser = localStorage.getItem('currentUser');
    
    let currentStreakData = 0;

    if (!currentUser) window.location.href = 'index.html';
    document.getElementById('displayName').innerText = currentUser;
    document.getElementById('displayIcon').innerText = localStorage.getItem('userIcon') || 'üë§';

    window.logout = function() { if(confirm("Logout?")) { localStorage.clear(); window.location.href = 'index.html'; }};

    window.showStreakDetails = function() {
        alert(`üî• Current Streak: ${currentStreakData} Days\n\nKeep conquering at least 100m¬≤ daily to maintain your streak and earn bonus points!`);
    };

    window.acceptInvite = async (newClanId) => {
        if(!confirm(`Join ${newClanId}?`)) return;
        const userSnap = await get(child(ref(db), `users/${currentUser}`));
        const oldClan = userSnap.val().clan;
        const updates = {};
        if (oldClan) updates[`clans/${oldClan}/members/${currentUser}`] = null;
        updates[`clans/${newClanId}/members/${currentUser}`] = true;
        updates[`users/${currentUser}/clan`] = newClanId;
        updates[`users/${currentUser}/invites/${newClanId}`] = null;
        await update(ref(db), updates);
        alert(`Joined ${newClanId}!`);
    };

    window.rejectInvite = async (clanId) => { if(!confirm("Ignore?")) return; await set(ref(db), `users/${currentUser}/invites/${clanId}`, null); };

    onValue(ref(db, `users/${currentUser}`), (snapshot) => {
        const user = snapshot.val();
        if(!user) return; 

        document.getElementById('creditPoints').innerText = user.creditPoints || 0;
        currentStreakData = user.streak || 0;

        const panel = document.getElementById('invitesPanel');
        if (user.invites) {
            panel.style.display = 'block';
            panel.innerHTML = "";
            Object.keys(user.invites).forEach(c => {
                panel.innerHTML += `<div class="invite-card"><div class="invite-text">INVITE: <b>${c}</b></div><div><button class="btn-accept-sm" onclick="window.acceptInvite('${c}')">Accept</button><button class="btn-decline-sm" onclick="window.rejectInvite('${c}')">Reject</button></div></div>`;
            });
        } else { panel.style.display = 'none'; }

        if (user.clan) {
            document.getElementById('clanControlPanel').style.display = 'block';
            document.getElementById('noClanPanel').style.display = 'none';
            document.getElementById('myClanName').innerText = user.clan;
            document.getElementById('statusText').innerText = `Warrior of ${user.clan}`;
            loadClanStats(user.clan);
        } else {
            document.getElementById('clanControlPanel').style.display = 'none';
            document.getElementById('noClanPanel').style.display = 'block';
            document.getElementById('statusText').innerText = "Wandering Nomad";
        }
    });

    document.getElementById('createBtn').addEventListener('click', async () => {
        const name = document.getElementById('newClanInput').value.trim().toUpperCase();
        if(!name) return;
        const snap = await get(child(ref(db), `clans/${name}`));
        if(snap.exists()) return alert("Taken!");
        await set(ref(db, `clans/${name}`), { leader: currentUser, members: { [currentUser]: true }, created: Date.now() });
        await update(ref(db, `users/${currentUser}`), { clan: name });
    });

    onValue(ref(db, 'territories'), (snap) => {
        const data = snap.val() || {};
        let myA = 0;
        Object.values(data).forEach(t => { if(t.owner === currentUser) myA += (t.areaSize || 0); });
        document.getElementById('myArea').innerText = Math.round(myA).toLocaleString() + " m¬≤";
    });

    function loadClanStats(clanId) {
        get(child(ref(db), `clans/${clanId}/members`)).then(mSnap => {
            const members = mSnap.val() || {};
            get(ref(db, 'territories')).then(tSnap => {
                const data = tSnap.val() || {};
                let cA = 0;
                Object.values(data).forEach(t => { if(members[t.owner]) cA += (t.areaSize || 0); });
                document.getElementById('clanArea').innerText = Math.round(cA).toLocaleString() + " m¬≤";
            });
        });
    }
</script>
</body>
</html>