<!DOCTYPE html>
<html>
<head>
    <title>Land Market - Drag & Drop</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; }
        .header { background: #111; padding: 15px; border-bottom: 2px solid #C5A059; text-align: center; color: white; display:flex; justify-content:space-between; align-items:center; }
        .bank-display { color: #FFD700; font-weight: bold; font-size: 1.1rem; border: 1px solid #C5A059; padding: 5px 10px; border-radius: 4px; }
        
        #map { flex: 1; position: relative; background: #e0e0e0; }
        
        .controls { padding: 15px; background: #111; border-top: 1px solid #333; text-align: center; }
        .btn-claim { background: #C5A059; color: black; border: none; padding: 15px 30px; font-weight: bold; font-family: 'Cinzel', serif; font-size: 1.1rem; border-radius: 4px; cursor: pointer; width: 100%; max-width: 300px; transition: background 0.3s; }
        .btn-claim:disabled { background: #555; color: #888; cursor: not-allowed; animation: none; }
        .btn-claim.confirm { background: #d32f2f; color: white; animation: pulse 1.5s infinite; }
        .btn-back { background: none; border: 1px solid #555; color: #888; padding: 5px 10px; font-size: 0.8rem; cursor: pointer; border-radius: 4px; }

        .legend { position: absolute; bottom: 140px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 4px; font-size: 0.8rem; color: #ccc; pointer-events: none; z-index: 5; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .color-box { width: 15px; height: 15px; margin-right: 8px; border: 1px solid #fff; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }
    </style>
</head>
<body>
    <div class="header">
        <button class="btn-back" onclick="window.location.href='dashboard.html'">Back</button>
        <div class="bank-display">Banked: <span id="bankVal">0</span> m²</div>
        <div style="width:50px;"></div> 
    </div>

    <div id="map">
        <div class="legend">
            <div class="legend-item"><div class="color-box" style="background:#00e676; opacity:0.6;"></div>Your Land</div>
            <div class="legend-item"><div class="color-box" style="background:#2196F3; opacity:0.6;"></div>Ally (Clan)</div>
            <div class="legend-item"><div class="color-box" style="background:#F44336; opacity:0.6;"></div>Enemy</div>
            <div class="legend-item"><div class="color-box" style="background:#FFD700; opacity:0.6; border:1px dashed white;"></div>Drag Me</div>
        </div>
    </div>

    <div class="controls">
        <div id="statusText" style="color:#888; font-size:0.9rem; margin-bottom:10px;">Click Preview, then Drag circle to target.</div>
        <button class="btn-claim" id="btnClaim">SPAWN PREVIEW</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, update, onValue, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const GOOGLE_API_KEY = "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k"; 
        const firebaseConfig = { databaseURL: "https://runmate-cb328-default-rtdb.firebaseio.com/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const currentUser = localStorage.getItem('currentUser');

        if (!currentUser) window.location.href = 'index.html';

        let map, bankAmount = 0;
        let myClanId = null;
        let allPolygons = []; 
        let previewPolygon = null; 
        let previewCoords = null;  
        let isPreviewMode = false; 

        window.initMap = function() {
            const mapEl = document.getElementById("map");
            try {
                map = new google.maps.Map(mapEl, {
                    zoom: 18, center: { lat: 0, lng: 0 }, mapTypeId: 'roadmap', disableDefaultUI: true,
                    styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
                });

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(pos => {
                        map.setCenter({ lat: pos.coords.latitude, lng: pos.coords.longitude });
                    });
                } else { map.setCenter({ lat: 40.7128, lng: -74.0060 }); }

                loadUserData(); 
                loadExistingLands();
            } catch (err) { console.error("Map Error:", err); }
        };

        function loadGoogleMaps() {
            if (document.getElementById('google-maps-script')) return; 
            const script = document.createElement('script');
            script.id = 'google-maps-script';
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_API_KEY}&libraries=geometry&callback=initMap`;
            script.async = true; script.defer = true;
            document.head.appendChild(script);
        }

        function loadUserData() {
            onValue(ref(db, `users/${currentUser}`), (snap) => {
                const val = snap.val();
                if(val) {
                    bankAmount = val.bankedArea || 0;
                    myClanId = val.clanId || null;
                }
                document.getElementById('bankVal').innerText = Math.round(bankAmount);
                checkButtonState();
            });
        }

        function checkButtonState() {
            const btn = document.getElementById('btnClaim');
            if (bankAmount < 5) {
                btn.disabled = true; 
                btn.innerText = "Insufficient Banked Area";
                btn.classList.remove('confirm');
            } else if (!isPreviewMode) {
                btn.disabled = false; 
                btn.style.background = "#C5A059"; 
                btn.innerText = "SPAWN PREVIEW";
                btn.classList.remove('confirm');
            }
        }

        function resetPreview() {
            if (previewPolygon) {
                previewPolygon.setMap(null);
                previewPolygon = null;
            }
            previewCoords = null;
            isPreviewMode = false;
            document.getElementById('statusText').innerText = "Click Preview, then Drag circle to target.";
            checkButtonState();
        }

        function loadExistingLands() {
            onValue(ref(db, 'territories'), (snapshot) => {
                const data = snapshot.val();
                if(allPolygons.length > 0) { 
                    allPolygons.forEach(p => p.googlePoly.setMap(null)); 
                    allPolygons = []; 
                }

                if (data) {
                    Object.entries(data).forEach(([key, t]) => {
                        let fillC, strokeC;
                        const isMine = t.owner === currentUser;
                        const isAlly = !isMine && myClanId && t.clanId === myClanId; 

                        if (isMine) { fillC = '#00e676'; strokeC = '#004d26'; }
                        else if (isAlly) { fillC = '#2196F3'; strokeC = '#0D47A1'; } 
                        else { fillC = '#F44336'; strokeC = '#B71C1C'; } 

                        const zIdx = isMine ? 10 : 1;
                        
                        const poly = new google.maps.Polygon({
                            paths: t.coords, fillColor: fillC, fillOpacity: 0.5, strokeColor: strokeC, strokeWeight: 2, zIndex: zIdx, map: map, clickable: false 
                        });

                        const tCoords = t.coords.map(c => [c.lng, c.lat]);
                        if (tCoords.length > 0 && (tCoords[0][0] !== tCoords[tCoords.length-1][0] || tCoords[0][1] !== tCoords[tCoords.length-1][1])) {
                            tCoords.push(tCoords[0]);
                        }
                        
                        let turfPoly = turf.polygon([tCoords]);
                        turfPoly = turf.rewind(turfPoly);

                        allPolygons.push({ 
                            id: key, 
                            owner: t.owner, 
                            clan: t.clanId || null,
                            turfPoly: turfPoly, 
                            googlePoly: poly
                        });
                    });
                }
            });
        }

        // --- VALIDATION LOGIC ---
        function validatePlacement(currentCoords) {
            // Convert Google Coords to Turf Poly
            const turfCoords = currentCoords.map(c => [c.lng, c.lat]);
            turfCoords.push([currentCoords[0].lng, currentCoords[0].lat]); 
            const newPoly = turf.polygon([turfCoords]);

            let touchesEnemy = false;
            let isValid = true;
            let msg = "Valid Location";

            for(const existing of allPolygons) {
                if (turf.booleanIntersects(newPoly, existing.turfPoly)) { 
                    
                    if (existing.owner === currentUser) {
                        isValid = false; msg = "Cannot overlap SELF"; break;
                    }
                    if (myClanId && existing.clan === myClanId) {
                        isValid = false; msg = "Cannot overlap ALLY"; break;
                    }
                    touchesEnemy = true;
                }
            }

            return { isValid, touchesEnemy, msg };
        }

        // --- BUTTON HANDLER ---
        document.getElementById('btnClaim').addEventListener('click', async () => {
            if(bankAmount < 5) return;
            const btn = document.getElementById('btnClaim');
            const statusTxt = document.getElementById('statusText');

            // --- STEP 1: SPAWN DRAGGABLE PREVIEW ---
            if (!isPreviewMode) {
                const center = map.getCenter();
                const radiusMeters = Math.sqrt(bankAmount / Math.PI);
                
                previewCoords = generateCircleCoords(center.lat(), center.lng(), radiusMeters);
                
                // CREATE DRAGGABLE POLYGON
                previewPolygon = new google.maps.Polygon({
                    paths: previewCoords,
                    fillColor: "#FFD700",
                    fillOpacity: 0.6,
                    strokeColor: "#FFD700",
                    strokeWeight: 2,
                    draggable: true, // <--- ENABLE DRAGGING
                    geodesic: true,
                    map: map,
                    zIndex: 100
                });

                // Attach Drag Listener
                google.maps.event.addListener(previewPolygon, 'dragend', function() {
                    // 1. Get new coords
                    const rawPath = this.getPath().getArray();
                    const newCoords = rawPath.map(p => ({ lat: p.lat(), lng: p.lng() }));
                    previewCoords = newCoords;

                    // 2. Validate Position
                    const check = validatePlacement(newCoords);

                    // 3. Update UI based on Validity
                    if(!check.isValid) {
                        this.setOptions({ fillColor: "#d32f2f", strokeColor: "#d32f2f" }); // Red
                        btn.disabled = true;
                        btn.innerText = "INVALID POSITION";
                        btn.classList.remove('confirm');
                        statusTxt.innerText = `⚠️ ${check.msg}`;
                    } else {
                        this.setOptions({ fillColor: "#FFD700", strokeColor: "#FFD700" }); // Gold
                        btn.disabled = false;
                        if(check.touchesEnemy) {
                            btn.innerText = "ATTACK & CLAIM";
                            btn.classList.add('confirm');
                            statusTxt.innerText = "⚔️ Targeting Enemy! Ready to attack.";
                        } else {
                            btn.innerText = "CONFIRM CLAIM";
                            btn.classList.remove('confirm');
                            statusTxt.innerText = "✅ Valid location. Ready to claim.";
                        }
                    }
                });

                // Run initial validation immediately on spawn
                google.maps.event.trigger(previewPolygon, 'dragend');

                isPreviewMode = true;
                return;
            }

            // --- STEP 2: CONFIRMATION ---
            if (isPreviewMode && previewCoords) {
                // Check validation one last time before submitting
                const finalCheck = validatePlacement(previewCoords);
                if(!finalCheck.isValid) {
                    alert("Invalid placement! Please move the selection to a valid area.");
                    return;
                }

                if(!confirm(`Finalize capture of ${Math.round(bankAmount)} m²?`)) return;

                const updates = {};
                const newKey = push(ref(db, 'territories')).key;
                
                // Turf Math for Cuts
                const myTurfCoords = previewCoords.map(c => [c.lng, c.lat]);
                myTurfCoords.push(myTurfCoords[0]);
                const myTurfPoly = turf.polygon([myTurfCoords]);

                updates[`territories/${newKey}`] = { 
                    owner: currentUser, 
                    clanId: myClanId || null,
                    coords: previewCoords, 
                    areaSize: bankAmount, 
                    timestamp: Date.now(), 
                    source: 'Market' 
                };

                updates[`users/${currentUser}/bankedArea`] = 0; 

                let enemiesHit = 0;

                // Cut Logic
                allPolygons.forEach(target => {
                    if (turf.booleanIntersects(myTurfPoly, target.turfPoly)) {
                        const diff = turf.difference(target.turfPoly, myTurfPoly);

                        if (!diff) {
                            updates[`territories/${target.id}`] = null; 
                            enemiesHit++;
                        } else {
                            const geometryType = diff.geometry.type;
                            if (geometryType === 'Polygon') {
                                const newCoords = diff.geometry.coordinates[0].map(pt => ({ lat: pt[1], lng: pt[0] }));
                                newCoords.pop(); 
                                updates[`territories/${target.id}/coords`] = newCoords;
                                enemiesHit++;
                            } else if (geometryType === 'MultiPolygon') {
                                const newCoords = diff.geometry.coordinates[0][0].map(pt => ({ lat: pt[1], lng: pt[0] }));
                                newCoords.pop();
                                updates[`territories/${target.id}/coords`] = newCoords;
                                enemiesHit++;
                            }
                        }
                    }
                });

                const userSnap = await get(ref(db, `users/${currentUser}`));
                const currentPoints = userSnap.val().creditPoints || 0;
                updates[`users/${currentUser}/creditPoints`] = currentPoints + 10 + (enemiesHit * 50);

                try { 
                    await update(ref(db), updates); 
                    resetPreview(); 
                    alert(enemiesHit > 0 ? "⚔️ Victory! Enemy territory captured." : "Territory Claimed Successfully!"); 
                    window.location.href = 'dashboard.html'; 
                } catch(e) { 
                    alert("Error: " + e.message); 
                }
            }
        });

        function generateCircleCoords(lat, lng, radius) {
            const points = 32; const coords = [];
            for (let i = 0; i < points; i++) {
                const theta = (i / points) * (2 * Math.PI);
                const offset = google.maps.geometry.spherical.computeOffset(new google.maps.LatLng(lat, lng), radius, (theta * 180) / Math.PI);
                coords.push({ lat: offset.lat(), lng: offset.lng() });
            }
            return coords;
        }

        loadGoogleMaps();
    </script>
</body>
</html>
