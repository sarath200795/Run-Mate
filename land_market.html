<!DOCTYPE html>
<html>
<head>
    <title>Land Market - Social</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        /* Header & Map Styles */
        .header { background: #111; padding: 15px; border-bottom: 2px solid #C5A059; text-align: center; color: white; display:flex; justify-content:space-between; align-items:center; }
        .bank-display { color: #FFD700; font-weight: bold; font-size: 1.1rem; border: 1px solid #C5A059; padding: 5px 10px; border-radius: 4px; }
        #map { flex: 1; position: relative; background: #e0e0e0; }
        
        /* Buttons */
        .controls { padding: 15px; background: #111; border-top: 1px solid #333; text-align: center; display:flex; gap:10px; justify-content: center; }
        .btn-claim { flex: 2; background: #C5A059; color: black; border: none; padding: 15px; font-weight: bold; font-family: 'Cinzel', serif; font-size: 1rem; border-radius: 4px; cursor: pointer; }
        .btn-social { flex: 1; background: #3b5998; color: white; border: none; padding: 15px; border-radius: 4px; cursor: pointer; font-size: 1.2rem; }
        .btn-claim:disabled { background: #555; color: #888; }
        .btn-claim.confirm { background: #d32f2f; color: white; animation: pulse 1.5s infinite; }

        /* Social Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 100; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; width: 90%; max-width: 400px; border: 1px solid #C5A059; border-radius: 8px; padding: 20px; color: white; max-height: 80vh; overflow-y: auto; }
        .friend-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; }
        .friend-name { font-weight: bold; color: #fff; }
        .friend-stats { text-align: right; font-size: 0.9rem; color: #C5A059; }
        .rank-badge { background: #333; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 8px; }
        .social-login-btn { width: 100%; padding: 10px; margin-top: 10px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); } }
    </style>
</head>
<body>
    <div class="header">
        <button onclick="window.location.href='dashboard.html'" style="background:none; border:1px solid #555; color:#888; padding:5px;">Back</button>
        <div class="bank-display">Banked: <span id="bankVal">0</span> m²</div>
        <div style="width:50px;"></div> 
    </div>

    <div id="map"></div>

    <div class="controls">
        <button class="btn-social" onclick="toggleSocial()"><i class="fas fa-users"></i></button>
        <button class="btn-claim" id="btnClaim">SPAWN PREVIEW</button>
    </div>

    <div id="socialModal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h2 style="margin:0; font-family:'Cinzel', serif;">Social Hub</h2>
                <button onclick="toggleSocial()" style="background:none; border:none; color:white; font-size:1.5rem;">&times;</button>
            </div>

            <div id="loginSection" style="display:none; border-bottom:1px solid #555; padding-bottom:15px; margin-bottom:15px;">
                <p style="color:#888; font-size:0.9rem;">Connect accounts to find friends:</p>
                <button class="social-login-btn" style="background:#DB4437; color:white;" onclick="socialLogin('google')">
                    <i class="fab fa-google"></i> Continue with Google
                </button>
                <button class="social-login-btn" style="background:#4267B2; color:white;" onclick="socialLogin('facebook')">
                    <i class="fab fa-facebook-f"></i> Continue with Facebook
                </button>
            </div>

            <h4 style="color:#888; margin-top:0;">Global Leaderboard</h4>
            <div id="friendsList">
                <div style="text-align:center; padding:20px; color:#666;">Loading data...</div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, update, onValue, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, FacebookAuthProvider } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        // CONFIGURATION
        const GOOGLE_API_KEY = "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k"; 
        const firebaseConfig = { databaseURL: "https://runmate-cb328-default-rtdb.firebaseio.com/" }; // Add apiKey/authDomain here for real Auth
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        const currentUser = localStorage.getItem('currentUser') || 'guest_user';

        // --- GOOGLE MAPS SETUP (Same as before) ---
        let map, bankAmount = 0, allPolygons = [], previewPolygon = null, previewCoords = null, isPreviewMode = false;

        window.initMap = function() {
            const mapEl = document.getElementById("map");
            map = new google.maps.Map(mapEl, {
                zoom: 18, center: { lat: 0, lng: 0 }, mapTypeId: 'roadmap', disableDefaultUI: true,
                styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
            });
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => { map.setCenter({ lat: pos.coords.latitude, lng: pos.coords.longitude }); });
            }
            loadUserData();
            loadExistingLands();
            loadSocialData(); // <--- NEW: Load friends data
        };

        // --- SOCIAL FEATURES ---
        
        // 1. Social Login Logic
        window.socialLogin = async (providerName) => {
            let provider;
            if (providerName === 'google') provider = new GoogleAuthProvider();
            if (providerName === 'facebook') provider = new FacebookAuthProvider();

            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                alert(`Welcome ${user.displayName}! Accounts linked.`);
                // Link this auth UID to your existing 'currentUser' logic or replace it
                localStorage.setItem('currentUser', user.uid);
                location.reload();
            } catch (error) {
                console.error(error);
                alert("Login Failed: " + error.message + "\n(Did you enable this provider in Firebase Console?)");
            }
        };

        // 2. Load Leaderboard/Friends
        function loadSocialData() {
            const listContainer = document.getElementById('friendsList');
            
            // In a real app, you would fetch `users/{uid}/friends`
            // For this demo, we fetch ALL users to make a global leaderboard
            onValue(ref(db, 'users'), (snapshot) => {
                const users = snapshot.val();
                if (!users) {
                    listContainer.innerHTML = "<div style='padding:10px'>No active players found.</div>";
                    return;
                }

                // Convert object to array and sort by Credit Points
                const sortedUsers = Object.entries(users)
                    .map(([id, data]) => ({ id, ...data }))
                    .sort((a, b) => (b.creditPoints || 0) - (a.creditPoints || 0));

                let html = '';
                sortedUsers.forEach((u, index) => {
                    const isMe = u.id === currentUser;
                    const name = u.displayName || u.email || `Player ${u.id.substr(0,4)}`;
                    const rank = index + 1;
                    const points = u.creditPoints || 0;
                    const banked = Math.round(u.bankedArea || 0);

                    // Add color highlighting for self
                    const bgStyle = isMe ? 'background:rgba(197, 160, 89, 0.1); border-left: 3px solid #C5A059;' : '';

                    html += `
                        <div class="friend-row" style="${bgStyle}">
                            <div>
                                <span class="rank-badge">#${rank}</span>
                                <span class="friend-name">${name} ${isMe ? '(You)' : ''}</span>
                            </div>
                            <div class="friend-stats">
                                <div style="color:#00e676;">${points} pts</div>
                                <div style="color:#888; font-size:0.8rem;">Bank: ${banked} m²</div>
                            </div>
                        </div>
                    `;
                });
                listContainer.innerHTML = html;
            });
        }

        window.toggleSocial = function() {
            const modal = document.getElementById('socialModal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        }

        // --- EXISTING GAME LOGIC (Briefly retained for functionality) ---
        function loadGoogleMaps() {
            if (document.getElementById('google-maps-script')) return; 
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_API_KEY}&libraries=geometry&callback=initMap`;
            document.head.appendChild(script);
        }

        function loadUserData() {
            onValue(ref(db, `users/${currentUser}`), (snap) => {
                const val = snap.val();
                bankAmount = val ? (val.bankedArea || 0) : 0;
                document.getElementById('bankVal').innerText = Math.round(bankAmount);
                checkButtonState();
            });
        }
        
        function checkButtonState() {
            const btn = document.getElementById('btnClaim');
            if (bankAmount < 5) {
                btn.disabled = true; btn.innerText = "Insufficient Area";
            } else {
                btn.disabled = false; btn.innerText = "SPAWN PREVIEW";
            }
        }

        function loadExistingLands() {
            onValue(ref(db, 'territories'), (snapshot) => {
                // (Existing land rendering logic hidden for brevity - assumes same as previous step)
                // ... Just ensure previous logic for `allPolygons` and `turf` is here ...
            });
        }

        // (Add the rest of your button click/drag logic from the previous step here)
        // ...
        
        loadGoogleMaps();
    </script>
</body>
</html>
