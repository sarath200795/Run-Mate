<!DOCTYPE html>
<html>
<head>
    <title>Land Market</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; background: #000; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; }
        .header { background: #111; padding: 15px; border-bottom: 2px solid #C5A059; text-align: center; color: white; display:flex; justify-content:space-between; align-items:center; }
        .bank-display { color: #FFD700; font-weight: bold; font-size: 1.1rem; border: 1px solid #C5A059; padding: 5px 10px; border-radius: 4px; }
        #map { flex: 1; position: relative; background: #e0e0e0; }
        .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 40px; height: 40px; pointer-events: none; z-index: 10; opacity: 0.8; }
        .controls { padding: 15px; background: #111; border-top: 1px solid #333; text-align: center; }
        .btn-claim { background: #C5A059; color: black; border: none; padding: 15px 30px; font-weight: bold; font-family: 'Cinzel', serif; font-size: 1.1rem; border-radius: 4px; cursor: pointer; width: 100%; max-width: 300px; }
        .btn-back { background: none; border: 1px solid #555; color: #888; padding: 5px 10px; font-size: 0.8rem; cursor: pointer; border-radius: 4px; }
        .legend { position: absolute; bottom: 140px; left: 10px; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 4px; font-size: 0.8rem; color: #ccc; pointer-events: none; z-index: 5; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .color-box { width: 15px; height: 15px; margin-right: 8px; border: 1px solid #fff; }
    </style>
</head>
<body>
    <div class="header">
        <button class="btn-back" onclick="window.location.href='dashboard.html'">Back</button>
        <div class="bank-display">Banked: <span id="bankVal">0</span> m²</div>
        <div style="width:50px;"></div> 
    </div>
    <div id="map">
        <div class="legend">
            <div class="legend-item"><div class="color-box" style="background:#00e676; opacity:0.6;"></div>Your Land</div>
            <div class="legend-item"><div class="color-box" style="background:#888; opacity:0.6;"></div>Occupied</div>
        </div>
        <svg class="crosshair" viewBox="0 0 100 100">
            <line x1="50" y1="0" x2="50" y2="100" stroke="#000" stroke-width="2" />
            <line x1="0" y1="50" x2="100" y2="50" stroke="#000" stroke-width="2" />
            <circle cx="50" cy="50" r="40" stroke="#000" stroke-width="2" fill="none" />
        </svg>
    </div>
    <div class="controls">
        <div style="color:#888; font-size:0.9rem; margin-bottom:10px;">Drag map to position target (Must be empty space)</div>
        <button class="btn-claim" id="btnClaim">CLAIM THIS SPOT</button>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, push, update, onValue, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        const GOOGLE_API_KEY = "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k"; 
        const firebaseConfig = { databaseURL: "https://runmate-cb328-default-rtdb.firebaseio.com/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const currentUser = localStorage.getItem('currentUser');
        if (!currentUser) window.location.href = 'index.html';
        let map, bankAmount = 0; let allPolygons = []; 
        window.initMap = function() {
            const mapEl = document.getElementById("map");
            try {
                map = new google.maps.Map(mapEl, { zoom: 18, center: { lat: 0, lng: 0 }, mapTypeId: 'roadmap', disableDefaultUI: true, styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }] });
                if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => { map.setCenter({ lat: pos.coords.latitude, lng: pos.coords.longitude }); }); } 
                else { map.setCenter({ lat: 40.7128, lng: -74.0060 }); }
                loadUserData(); loadExistingLands();
            } catch (err) { console.error("Map Error:", err); }
        };
        function loadGoogleMaps() {
            if (document.getElementById('google-maps-script')) return; 
            const script = document.createElement('script'); script.id = 'google-maps-script'; script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_API_KEY}&libraries=geometry&callback=initMap`; script.async = true; script.defer = true; document.head.appendChild(script);
        }
        function loadUserData() {
            onValue(ref(db, `users/${currentUser}`), (snap) => {
                const val = snap.val(); bankAmount = val ? (val.bankedArea || 0) : 0;
                document.getElementById('bankVal').innerText = Math.round(bankAmount);
                const btn = document.getElementById('btnClaim');
                if(bankAmount < 5) { btn.disabled = true; btn.style.background = "#333"; btn.innerText = "Insufficient Banked Area"; } 
                else { btn.disabled = false; btn.style.background = "#C5A059"; btn.innerText = "CLAIM THIS SPOT"; }
            });
        }
        function loadExistingLands() {
            onValue(ref(db, 'territories'), (snapshot) => {
                const data = snapshot.val();
                if(allPolygons.length > 0) { allPolygons.forEach(p => p.poly.setMap(null)); allPolygons = []; }
                if (data) Object.values(data).forEach(t => {
                    const isMine = t.owner === currentUser; const fillC = isMine ? '#00e676' : '#555555'; const strokeC = isMine ? '#004d26' : '#222222'; const zIdx = isMine ? 10 : 1;
                    const poly = new google.maps.Polygon({ paths: t.coords, fillColor: fillC, fillOpacity: 0.5, strokeColor: strokeC, strokeWeight: 2, zIndex: zIdx, map: map, clickable: false });
                    const tCoords = t.coords.map(c => [c.lng, c.lat]); tCoords.push([t.coords[0].lng, t.coords[0].lat]);
                    allPolygons.push({ turfPoly: turf.polygon([tCoords]), poly: poly });
                });
            });
        }
        document.getElementById('btnClaim').addEventListener('click', async () => {
            if(bankAmount < 5) return;
            const center = map.getCenter(); const lat = center.lat(); const lng = center.lng();
            const radiusMeters = Math.sqrt(bankAmount / Math.PI);
            const circleCoords = generateCircleCoords(lat, lng, radiusMeters);
            const turfCoords = circleCoords.map(c => [c.lng, c.lat]); turfCoords.push([circleCoords[0].lng, circleCoords[0].lat]); const newPoly = turf.polygon([turfCoords]);
            for(const existing of allPolygons) { if (turf.intersect(newPoly, existing.turfPoly)) { return alert("Cannot claim here! Area overlaps with existing territory."); } }
            if(!confirm(`Claim this location for ${Math.round(bankAmount)} m²?`)) return;
            const updates = {}; const newKey = push(ref(db, 'territories')).key;
            updates[`territories/${newKey}`] = { owner: currentUser, coords: circleCoords, areaSize: bankAmount, timestamp: Date.now(), source: 'Market' };
            updates[`users/${currentUser}/bankedArea`] = 0; 
            const userSnap = await get(ref(db, `users/${currentUser}`)); const currentPoints = userSnap.val().creditPoints || 0;
            updates[`users/${currentUser}/creditPoints`] = currentPoints + 10;
            try { await update(ref(db), updates); alert("Territory Claimed Successfully!"); window.location.href = 'dashboard.html'; } catch(e) { alert("Error: " + e.message); }
        });
        function generateCircleCoords(lat, lng, radius) {
            const points = 32; const coords = [];
            for (let i = 0; i < points; i++) {
                const theta = (i / points) * (2 * Math.PI); const offset = google.maps.geometry.spherical.computeOffset(new google.maps.LatLng(lat, lng), radius, (theta * 180) / Math.PI);
                coords.push({ lat: offset.lat(), lng: offset.lng() });
            } return coords;
        }
        loadGoogleMaps();
    </script>
</body>
</html>
