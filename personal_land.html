<!DOCTYPE html>
<html lang="en">
<head>
    <title>My Conquests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        
        .header { background: #111; padding: 15px; text-align: center; border-bottom: 2px solid #8B0000; flex-shrink: 0; position: relative;}
        h1 { margin: 0; font-family: 'Cinzel', serif; color: #00e676; font-size: 1.4rem; letter-spacing: 1px; }
        .back-btn { display: inline-block; margin-top: 5px; color: #888; text-decoration: none; font-size: 0.8rem; border: 1px solid #444; padding: 4px 10px; border-radius: 15px; }
        .points-display { position: absolute; top: 15px; right: 15px; color: #FFD700; font-weight: bold; font-size: 0.9rem; border: 1px solid #C5A059; padding: 5px 10px; border-radius: 4px; background: #220; }

        /* Map Container */
        #map { flex: 1; min-height: 40%; width: 100%; border-bottom: 2px solid #333; }

        /* List Container */
        .list-container { flex: 1; overflow-y: auto; padding: 20px; background: #1a1a1a; }
        .land-item { background: #222; margin-bottom: 10px; padding: 15px; border-radius: 8px; border-left: 4px solid #444; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .land-item:hover { background: #2a2a2a; }
        .land-item.market { border-left-color: #FFD700; } /* Gold for Market */
        .land-item.battle { border-left-color: #00e676; } /* Green for Battle */
        
        .land-info { display: flex; flex-direction: column; }
        .land-area { font-weight: bold; color: white; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .land-source { font-size: 0.8rem; margin-top: 2px; text-transform: uppercase; font-weight: bold; }
        .land-date { font-size: 0.75rem; color: #666; margin-top: 5px; }
        
        .guard-badge { background: #004d26; color: #00e676; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; border: 1px solid #00e676; display: flex; align-items: center; gap: 4px; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: #1a1a1a; padding: 25px; border: 2px solid #C5A059; border-radius: 8px; width: 90%; max-width: 400px; color: white; text-align: center; position: relative; }
        .modal h2 { color: #C5A059; margin-top: 0; font-family: 'Cinzel', serif; }
        .detail-row { display: flex; justify-content: space-between; margin: 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 0.95rem; }
        .detail-val { color: white; font-weight: bold; }
        .detail-lbl { color: #888; }
        
        /* Guard Section */
        .guard-section { background: #222; padding: 15px; border-radius: 6px; margin-top: 15px; border: 1px solid #444; }
        .guard-title { color: #FFD700; font-weight: bold; margin-bottom: 10px; display: block; font-family: 'Cinzel', serif; }
        .btn-deploy { background: #00e676; color: black; border: none; padding: 12px; width: 100%; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px; font-size: 1rem; }
        .btn-deploy:disabled { background: #444; color: #888; cursor: not-allowed; }
        .btn-close { background: none; border: 1px solid #666; color: #888; padding: 8px; width: 100%; margin-top: 10px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Empire Overview</h1>
        <div style="font-size:0.9rem; color:#aaa; margin-top:5px;">Total Area: <span id="totalAreaDisplay" style="color:white; font-weight:bold;">0</span> m¬≤</div>
        <div class="points-display">Pts: <span id="userPoints">...</span></div>
        <a href="dashboard.html" class="back-btn">‚Üê Back to Command</a>
    </div>

    <div id="map"></div>

    <div class="list-container" id="landList">
        <p style="text-align:center; color:#666;">Loading Territories...</p>
    </div>

    <div id="detailModal" class="modal">
        <div class="detail-content modal-content">
            <h2>Territory Command</h2>
            <div class="detail-row"><span class="detail-lbl">Source:</span><span class="detail-val" id="dSource">...</span></div>
            <div class="detail-row"><span class="detail-lbl">Area Size:</span><span class="detail-val" id="dArea">...</span></div>
            <div class="detail-row"><span class="detail-lbl">Location:</span><span class="detail-val" id="dLoc" style="font-size:0.8rem; max-width:60%; text-align:right;">Fetching...</span></div>
            
            <div class="guard-section" id="guardControl">
                <span class="guard-title">üõ°Ô∏è SECURITY STATUS</span>
                <div id="guardStatusText" style="color:#aaa; font-size:0.9rem; margin-bottom:10px;">Unprotected</div>
                
                <div id="deployUI">
                    <div class="detail-row"><span class="detail-lbl">Guards Required:</span><span class="detail-val" id="gReq">0</span></div>
                    <div class="detail-row"><span class="detail-lbl">Cost (10pts/Guard):</span><span class="detail-val" id="gCost" style="color:#FFD700">0</span></div>
                    <button id="btnDeploy" class="btn-deploy">DEPLOY GUARDS</button>
                </div>
                <div id="activeGuardUI" style="display:none; color:#00e676; font-weight:bold; padding:10px;">
                    ‚úÖ AREA SECURED<br>
                    <span style="font-size:0.8rem; color:#aaa; font-weight:normal;">Expires: <span id="gExpiry"></span></span>
                </div>
            </div>

            <button class="btn-close" onclick="document.getElementById('detailModal').style.display='none'">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const GOOGLE_API_KEY = "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k"; 
        const firebaseConfig = { databaseURL: "https://runmate-cb328-default-rtdb.firebaseio.com/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const currentUser = localStorage.getItem('currentUser');

        if (!currentUser) window.location.href = 'index.html';

        let map;
        let mapOverlays = []; // Stores polygons and markers for cleanup
        let currentPoints = 0;
        let selectedLandId = null;
        let selectedLandArea = 0;

        // Fetch User Points
        onValue(ref(db, `users/${currentUser}`), (snap) => {
            currentPoints = snap.val().creditPoints || 0;
            document.getElementById('userPoints').innerText = currentPoints;
        });

        window.initMap = function() {
            const mapEl = document.getElementById("map");
            try {
                map = new google.maps.Map(mapEl, {
                    zoom: 2, center: { lat: 20, lng: 0 }, mapTypeId: 'roadmap', disableDefaultUI: true,
                    styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
                });
                loadLands();
            } catch (err) { console.error("Map Error:", err); }
        };

        function loadGoogleMaps() {
            if (document.getElementById('google-maps-script')) return; 
            const script = document.createElement('script');
            script.id = 'google-maps-script';
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_API_KEY}&libraries=geometry&callback=initMap`;
            script.async = true; script.defer = true;
            document.head.appendChild(script);
        }

        function loadLands() {
            onValue(ref(db, 'territories'), (snapshot) => {
                const data = snapshot.val();
                const list = document.getElementById('landList');
                list.innerHTML = "";
                
                // Clear old map elements
                mapOverlays.forEach(obj => {
                    if (obj.setMap) obj.setMap(null); // Polygon or Marker
                });
                mapOverlays = [];

                let totalArea = 0;
                let bounds = new google.maps.LatLngBounds();
                let hasLands = false;

                if (data) {
                    const myLands = Object.entries(data).filter(([k, v]) => v.owner === currentUser);
                    
                    if(myLands.length === 0) {
                        list.innerHTML = "<p style='text-align:center; color:#444; margin-top:20px;'>No territories conquered yet.</p>";
                        return;
                    }

                    myLands.sort((a,b) => b[1].timestamp - a[1].timestamp);

                    myLands.forEach(([key, t]) => {
                        hasLands = true;
                        totalArea += (t.areaSize || 0);

                        // CLASSIFICATION LOGIC
                        const isMarket = t.source === 'Market';
                        // Market = Gold, Battle = Green
                        const color = isMarket ? '#FFD700' : '#00e676';
                        const stroke = isMarket ? '#B8860B' : '#004d26';

                        // Draw Polygon
                        const poly = new google.maps.Polygon({
                            paths: t.coords,
                            fillColor: color, fillOpacity: 0.5,
                            strokeColor: stroke, strokeWeight: 2,
                            map: map, clickable: true
                        });
                        
                        poly.addListener('click', () => showDetails(key, t));
                        mapOverlays.push(poly);
                        t.coords.forEach(c => bounds.extend(c));

                        // CHECK GUARD STATUS
                        let guardHtml = "";
                        const now = Date.now();
                        if (t.guarded && t.guardExpiry > now) {
                            const diff = t.guardExpiry - now;
                            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            
                            // List Item Badge
                            guardHtml = `<span class="guard-badge">üõ°Ô∏è ${d}d ${h}h</span>`;

                            // Map Marker
                            const center = getPolygonCenter(t.coords);
                            const marker = new google.maps.Marker({
                                position: center,
                                map: map,
                                label: { text: "üõ°Ô∏è", fontSize: "16px" },
                                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 0 },
                                zIndex: 100
                            });
                            mapOverlays.push(marker);
                        }

                        // List Item
                        const dateStr = new Date(t.timestamp).toLocaleDateString();
                        const sourceText = isMarket ? 'üè¶ MARKET (INDOOR)' : '‚öîÔ∏è CONQUEST (OUTDOOR)';
                        const sourceColor = isMarket ? '#FFD700' : '#00e676';
                        const itemClass = isMarket ? 'market' : 'battle';

                        const div = document.createElement('div');
                        div.className = `land-item ${itemClass}`;
                        div.innerHTML = `
                            <div class="land-info">
                                <span class="land-area">${Math.round(t.areaSize)} m¬≤ ${guardHtml}</span>
                                <span class="land-source" style="color:${sourceColor}">${sourceText}</span>
                                <span class="land-date">${dateStr}</span>
                            </div>
                            <div style="font-size:1.2rem; color:#444;">‚ùØ</div>
                        `;
                        div.onclick = () => {
                            const b = new google.maps.LatLngBounds();
                            t.coords.forEach(c => b.extend(c));
                            map.fitBounds(b);
                            showDetails(key, t);
                        };
                        list.appendChild(div);
                    });

                    if(hasLands) map.fitBounds(bounds);
                }
                document.getElementById('totalAreaDisplay').innerText = Math.round(totalArea).toLocaleString();
            });
        }

        async function showDetails(key, t) {
            selectedLandId = key;
            selectedLandArea = t.areaSize || 0;

            const modal = document.getElementById('detailModal');
            modal.style.display = 'flex';
            
            document.getElementById('dArea').innerText = Math.round(selectedLandArea) + " m¬≤";
            
            const isMarket = t.source === 'Market';
            const sEl = document.getElementById('dSource');
            sEl.innerText = isMarket ? "INDOOR / MARKET" : "OUTDOOR / CONQUEST";
            sEl.style.color = isMarket ? "#FFD700" : "#00e676";

            // Guard Logic in Modal
            const isGuarded = t.guarded && (t.guardExpiry > Date.now());
            if (isGuarded) {
                document.getElementById('deployUI').style.display = 'none';
                document.getElementById('activeGuardUI').style.display = 'block';
                document.getElementById('guardStatusText').innerText = "SECURE";
                document.getElementById('guardStatusText').style.color = "#00e676";
                document.getElementById('gExpiry').innerText = new Date(t.guardExpiry).toLocaleDateString();
            } else {
                document.getElementById('deployUI').style.display = 'block';
                document.getElementById('activeGuardUI').style.display = 'none';
                document.getElementById('guardStatusText').innerText = "VULNERABLE";
                document.getElementById('guardStatusText').style.color = "#ff4444";

                const guardsNeeded = selectedLandArea / 500;
                const cost = Math.ceil(guardsNeeded * 10); // Fractional calculation

                document.getElementById('gReq').innerText = guardsNeeded.toFixed(2);
                document.getElementById('gCost').innerText = cost + " Pts";
                
                const btn = document.getElementById('btnDeploy');
                btn.onclick = deployGuards; 

                if (currentPoints < cost) {
                    btn.disabled = true;
                    btn.innerText = "NOT ENOUGH POINTS";
                    btn.style.background = "#444";
                } else {
                    btn.disabled = false;
                    btn.innerText = `DEPLOY (${cost} PTS)`;
                    btn.style.background = "#00e676";
                }
            }

            const center = getPolygonCenter(t.coords);
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}`);
                const data = await response.json();
                const addr = data.address;
                const locName = addr.road || addr.suburb || addr.city || "Unknown Location";
                document.getElementById('dLoc').innerText = locName;
            } catch (e) { document.getElementById('dLoc').innerText = "Unknown Location"; }
        }

        async function deployGuards() {
            if(!selectedLandId) return;
            const guardsNeeded = selectedLandArea / 500;
            const cost = Math.ceil(guardsNeeded * 10);

            if(currentPoints < cost) return alert("Insufficient Credit Points!");

            if(!confirm(`Deploy ${guardsNeeded.toFixed(2)} Guards for ${cost} Points?\nProtects area for 7 Days.`)) return;

            const updates = {};
            updates[`territories/${selectedLandId}/guarded`] = true;
            updates[`territories/${selectedLandId}/guardExpiry`] = Date.now() + (7 * 24 * 60 * 60 * 1000); 
            updates[`users/${currentUser}/creditPoints`] = currentPoints - cost;

            try {
                await update(ref(db), updates);
                alert("Guards Deployed! Area is secure.");
                document.getElementById('detailModal').style.display = 'none';
            } catch(e) {
                alert("Error: " + e.message);
            }
        }

        function getPolygonCenter(coords) {
            let lat = 0, lng = 0;
            coords.forEach(c => { lat += c.lat; lng += c.lng; });
            return { lat: lat / coords.length, lng: lng / coords.length };
        }

        loadGoogleMaps();
    </script>
</body>
</html>
