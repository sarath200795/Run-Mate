<!DOCTYPE html>
<html lang="en">
<head>
    <title>My Conquests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        .header { background: #111; padding: 15px; text-align: center; border-bottom: 2px solid #8B0000; flex-shrink: 0; }
        h1 { margin: 0; font-family: 'Cinzel', serif; color: #00e676; font-size: 1.4rem; letter-spacing: 1px; }
        .back-btn { display: inline-block; margin-top: 5px; color: #888; text-decoration: none; font-size: 0.8rem; border: 1px solid #444; padding: 4px 10px; border-radius: 15px; }
        #map { flex: 1; min-height: 40%; width: 100%; border-bottom: 2px solid #333; }
        .list-container { flex: 1; overflow-y: auto; padding: 20px; background: #1a1a1a; }
        .land-item { background: #222; margin-bottom: 10px; padding: 15px; border-radius: 8px; border: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .land-item:hover { border-color: #00e676; background: #2a2a2a; }
        .land-info { display: flex; flex-direction: column; }
        .land-area { font-weight: bold; color: #C5A059; font-size: 1.1rem; }
        .land-source { font-size: 0.8rem; color: #aaa; margin-top: 2px; }
        .land-date { font-size: 0.75rem; color: #666; margin-top: 5px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: #1a1a1a; padding: 25px; border: 2px solid #C5A059; border-radius: 8px; width: 90%; max-width: 400px; color: white; text-align: center; position: relative; }
        .modal h2 { color: #C5A059; margin-top: 0; font-family: 'Cinzel', serif; }
        .detail-row { display: flex; justify-content: space-between; margin: 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 0.95rem; }
        .detail-val { color: white; font-weight: bold; }
        .detail-lbl { color: #888; }
        .btn-close { background: #444; color: white; border: none; padding: 10px; width: 100%; margin-top: 15px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Empire Overview</h1>
        <div style="font-size:0.9rem; color:#aaa; margin-top:5px;">Total Area: <span id="totalAreaDisplay" style="color:#C5A059; font-weight:bold;">0</span> m¬≤</div>
        <a href="dashboard.html" class="back-btn">‚Üê Back to Command</a>
    </div>
    <div id="map"></div>
    <div class="list-container" id="landList"><p style="text-align:center; color:#666;">Loading Territories...</p></div>
    <div id="detailModal" class="modal">
        <div class="detail-content modal-content">
            <h2>Territory Details</h2>
            <div class="detail-row"><span class="detail-lbl">Captured Via:</span><span class="detail-val" id="dSource" style="color:#00e676">...</span></div>
            <div class="detail-row"><span class="detail-lbl">Area Size:</span><span class="detail-val" id="dArea">...</span></div>
            <div class="detail-row"><span class="detail-lbl">Acquired Date:</span><span class="detail-val" id="dDate">...</span></div>
            <div class="detail-row"><span class="detail-lbl">Location:</span><span class="detail-val" id="dLoc" style="font-size:0.8rem; max-width:60%; text-align:right;">Fetching...</span></div>
            <button class="btn-close" onclick="document.getElementById('detailModal').style.display='none'">Close</button>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        const GOOGLE_API_KEY = "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k"; 
        const firebaseConfig = { databaseURL: "https://runmate-cb328-default-rtdb.firebaseio.com/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const currentUser = localStorage.getItem('currentUser');
        if (!currentUser) window.location.href = 'index.html';
        let map; let polygons = [];
        window.initMap = function() {
            const mapEl = document.getElementById("map");
            try {
                map = new google.maps.Map(mapEl, { zoom: 2, center: { lat: 20, lng: 0 }, mapTypeId: 'roadmap', disableDefaultUI: true, styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }] });
                loadLands();
            } catch (err) { console.error("Map Error:", err); }
        };
        function loadGoogleMaps() {
            if (document.getElementById('google-maps-script')) return; 
            const script = document.createElement('script'); script.id = 'google-maps-script'; script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_API_KEY}&libraries=geometry&callback=initMap`; script.async = true; script.defer = true; document.head.appendChild(script);
        }
        function loadLands() {
            onValue(ref(db, 'territories'), (snapshot) => {
                const data = snapshot.val();
                const list = document.getElementById('landList'); list.innerHTML = "";
                polygons.forEach(p => p.setMap(null)); polygons = [];
                let totalArea = 0; let bounds = new google.maps.LatLngBounds(); let hasLands = false;
                if (data) {
                    const myLands = Object.entries(data).filter(([k, v]) => v.owner === currentUser);
                    if(myLands.length === 0) { list.innerHTML = "<p style='text-align:center; color:#444; margin-top:20px;'>No territories conquered yet.</p>"; return; }
                    myLands.sort((a,b) => b[1].timestamp - a[1].timestamp);
                    myLands.forEach(([key, t]) => {
                        hasLands = true; totalArea += (t.areaSize || 0);
                        const poly = new google.maps.Polygon({ paths: t.coords, fillColor: '#00e676', fillOpacity: 0.4, strokeColor: '#004d26', strokeWeight: 2, map: map, clickable: true });
                        poly.addListener('click', () => { showDetails(t); });
                        polygons.push(poly); t.coords.forEach(c => bounds.extend(c));
                        const dateStr = new Date(t.timestamp).toLocaleDateString();
                        const source = t.source || "Battle"; 
                        const div = document.createElement('div'); div.className = 'land-item';
                        div.innerHTML = `<div class="land-info"><span class="land-area">${Math.round(t.areaSize)} m¬≤</span><span class="land-source">${source === 'Market' ? 'üè¶ Land Market' : '‚öîÔ∏è Outdoor Conquest'}</span><span class="land-date">${dateStr}</span></div><div style="font-size:1.2rem; color:#444;">‚ùØ</div>`;
                        div.onclick = () => { const b = new google.maps.LatLngBounds(); t.coords.forEach(c => b.extend(c)); map.fitBounds(b); };
                        list.appendChild(div);
                    });
                    if(hasLands) map.fitBounds(bounds);
                }
                document.getElementById('totalAreaDisplay').innerText = Math.round(totalArea).toLocaleString();
            });
        }
        async function showDetails(t) {
            document.getElementById('detailModal').style.display = 'flex';
            document.getElementById('dArea').innerText = Math.round(t.areaSize) + " m¬≤";
            document.getElementById('dDate').innerText = new Date(t.timestamp).toLocaleString();
            const source = t.source || "Battle";
            const sEl = document.getElementById('dSource');
            if(source === 'Market') { sEl.innerText = "LAND MARKET (Banked)"; sEl.style.color = "#FFD700"; } 
            else { sEl.innerText = "OUTDOOR BATTLE"; sEl.style.color = "#00e676"; }
            const center = getPolygonCenter(t.coords);
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}`);
                const data = await response.json(); const addr = data.address;
                const locName = addr.road || addr.suburb || addr.city || addr.town || "Unknown Wilderness";
                document.getElementById('dLoc').innerText = locName;
            } catch (e) { document.getElementById('dLoc').innerText = "Unknown Location"; }
        }
        function getPolygonCenter(coords) {
            let lat = 0, lng = 0; coords.forEach(c => { lat += c.lat; lng += c.lng; });
            return { lat: lat / coords.length, lng: lng / coords.length };
        }
        loadGoogleMaps();
    </script>
</body>
</html>
