<!DOCTYPE html>
<html lang="en">
<head>
    <title>My Conquests</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; margin: 0; padding: 20px; min-height: 100vh; }
        .header { text-align: center; border-bottom: 2px solid #8B0000; padding-bottom: 20px; margin-bottom: 20px; }
        h1 { margin: 0; font-family: 'Cinzel', serif; color: #00e676; font-size: 1.8rem; letter-spacing: 1px; }
        .stats-summary { display: flex; justify-content: center; gap: 20px; margin-top: 10px; }
        .stat-badge { background: #222; padding: 5px 15px; border-radius: 20px; border: 1px solid #444; font-size: 0.9rem; }
        .highlight { color: #00e676; font-weight: bold; }
        .land-list { max-width: 600px; margin: 0 auto; }
        .land-card { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; overflow: hidden; margin-bottom: 20px; animation: fadein 0.5s; }
        @keyframes fadein { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }
        .map-snap { width: 100%; height: 150px; background: #000; display: flex; align-items: center; justify-content: center; overflow: hidden; border-bottom: 1px solid #333; }
        .map-snap img { width: 100%; height: 100%; object-fit: cover; }
        .card-details { padding: 15px; }
        .location-name { font-size: 1.1rem; font-weight: bold; color: #C5A059; margin-bottom: 5px; font-family: 'Cinzel', serif; }
        .location-sub { font-size: 0.8rem; color: #888; display: flex; justify-content: space-between; align-items: center; }
        .area-badge { background: #331111; color: #ff4444; padding: 3px 8px; border-radius: 4px; font-weight: bold; }
        .back-btn { display: block; margin: 30px auto; text-align: center; color: #888; text-decoration: none; border: 1px solid #444; padding: 10px; width: 150px; border-radius: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>My Conquests</h1>
        <div class="stats-summary">
            <div class="stat-badge">Total: <span id="totalArea" class="highlight">0</span> m¬≤</div>
            <div class="stat-badge">Lands: <span id="totalCount" class="highlight">0</span></div>
        </div>
    </div>
    <div id="landList" class="land-list"><p style="text-align:center; color:#666; margin-top:50px;">Consulting the archives...</p></div>
    <a href="dashboard.html" class="back-btn">‚Üê Back to Base</a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://runmate-cb328-default-rtdb.firebaseio.com/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const currentUser = localStorage.getItem('currentUser');
        
        // INSERTED YOUR API KEY HERE
        const GOOGLE_API_KEY = "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k"; 

        if (!currentUser) window.location.href = 'index.html';

        async function loadLands() {
            const listDiv = document.getElementById('landList');
            try {
                const snapshot = await get(ref(db, 'territories'));
                const data = snapshot.val();
                
                if (!data) { listDiv.innerHTML = "<p style='text-align:center;'>You have not conquered any land yet.</p>"; return; }
                const myLands = Object.values(data).filter(t => t.owner === currentUser).sort((a, b) => b.timestamp - a.timestamp);

                let totalArea = 0;
                myLands.forEach(l => totalArea += (l.areaSize || 0));
                document.getElementById('totalArea').innerText = Math.round(totalArea).toLocaleString();
                document.getElementById('totalCount').innerText = myLands.length;

                if (myLands.length === 0) { listDiv.innerHTML = "<p style='text-align:center;'>You have not conquered any land yet.</p>"; return; }

                listDiv.innerHTML = "";
                for (const land of myLands) {
                    const center = getPolygonCenter(land.coords);
                    const card = document.createElement('div');
                    card.className = 'land-card';
                    const pathStr = land.coords.map(c => `${c.lat},${c.lng}`).join('|');
                    const mapUrl = `https://maps.googleapis.com/maps/api/staticmap?size=600x300&maptype=satellite&path=color:0x00e676|weight:2|fillcolor:0x00e67633|${pathStr}&key=${GOOGLE_API_KEY}`;

                    card.innerHTML = `<div class="map-snap"><img src="${mapUrl}" alt="Map"></div><div class="card-details"><div class="location-name" id="loc-${land.timestamp}">Loading Location...</div><div class="location-sub"><span>üìÖ ${new Date(land.timestamp).toLocaleDateString()}</span><span class="area-badge">${Math.round(land.areaSize)} m¬≤</span></div></div>`;
                    listDiv.appendChild(card);
                    fetchAddress(center.lat, center.lng, `loc-${land.timestamp}`);
                }
            } catch (err) { console.error(err); listDiv.innerHTML = "<p style='text-align:center; color:red;'>Error loading archives.</p>"; }
        }

        function getPolygonCenter(coords) {
            let lat = 0, lng = 0;
            coords.forEach(c => { lat += c.lat; lng += c.lng; });
            return { lat: lat / coords.length, lng: lng / coords.length };
        }

        async function fetchAddress(lat, lng, elementId) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                const data = await response.json();
                const addr = data.address;
                const locName = addr.county || addr.city || addr.town || addr.village || "Unknown Wilderness";
                document.getElementById(elementId).innerText = `${locName}, ${addr.state || ""}`;
            } catch (e) { document.getElementById(elementId).innerText = "Remote Territory"; }
        }
        loadLands();
    </script>
</body>
</html>