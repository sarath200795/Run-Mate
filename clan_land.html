<!DOCTYPE html>
<html lang="en">
<head>
    <title>Clan Dominion</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        
        .header { background: #111; padding: 15px; text-align: center; border-bottom: 2px solid #00bcd4; flex-shrink: 0; position: relative;}
        h1 { margin: 0; font-family: 'Cinzel', serif; color: #00bcd4; font-size: 1.4rem; letter-spacing: 1px; }
        .back-btn { display: inline-block; margin-top: 5px; color: #888; text-decoration: none; font-size: 0.8rem; border: 1px solid #444; padding: 4px 10px; border-radius: 15px; }
        .points-display { position: absolute; top: 15px; right: 15px; color: #FFD700; font-weight: bold; font-size: 0.9rem; border: 1px solid #C5A059; padding: 5px 10px; border-radius: 4px; background: #220; }

        #map { flex: 1; min-height: 40%; width: 100%; border-bottom: 2px solid #333; }

        .list-container { flex: 1; overflow-y: auto; padding: 20px; background: #1a1a1a; }
        .land-item { background: #222; margin-bottom: 10px; padding: 15px; border-radius: 8px; border-left: 4px solid #444; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .land-item:hover { background: #2a2a2a; }
        
        /* Specific Border Colors */
        .land-item.mine { border-left-color: #00e676; }
        .land-item.ally { border-left-color: #00bcd4; }

        .land-info { display: flex; flex-direction: column; }
        .owner-name { font-weight: bold; font-size: 0.9rem; }
        .land-area { font-weight: bold; color: white; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
        .guard-badge { background: #003333; color: #00bcd4; font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; border: 1px solid #00bcd4; display: flex; align-items: center; gap: 4px; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: #1a1a1a; padding: 25px; border: 2px solid #00bcd4; border-radius: 8px; width: 90%; max-width: 400px; color: white; text-align: center; position: relative; }
        .modal h2 { color: #00bcd4; margin-top: 0; font-family: 'Cinzel', serif; }
        .detail-row { display: flex; justify-content: space-between; margin: 10px 0; border-bottom: 1px solid #333; padding-bottom: 5px; font-size: 0.95rem; }
        .detail-val { color: white; font-weight: bold; }
        .detail-lbl { color: #888; }
        
        .guard-section { background: #222; padding: 15px; border-radius: 6px; margin-top: 15px; border: 1px solid #444; }
        .guard-title { color: #FFD700; font-weight: bold; margin-bottom: 10px; display: block; font-family: 'Cinzel', serif; }
        
        /* Slider Styles */
        .range-container { margin: 15px 0; text-align: left; }
        input[type=range] { width: 100%; margin: 10px 0; accent-color: #00bcd4; }
        .range-labels { display: flex; justify-content: space-between; font-size: 0.8rem; color: #888; }

        .btn-deploy { background: #00bcd4; color: black; border: none; padding: 12px; width: 100%; font-weight: bold; cursor: pointer; border-radius: 4px; margin-top: 10px; font-size: 1rem; }
        .btn-deploy:disabled { background: #444; color: #888; cursor: not-allowed; }
        .btn-close { background: none; border: 1px solid #666; color: #888; padding: 8px; width: 100%; margin-top: 10px; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Clan Dominion</h1>
        <div style="font-size:0.9rem; color:#aaa; margin-top:5px;">Clan Empire Area: <span id="totalClanArea" style="color:white; font-weight:bold;">0</span> m¬≤</div>
        <div class="points-display">Pts: <span id="userPoints">...</span></div>
        <a href="dashboard.html" class="back-btn">‚Üê Back to Command</a>
    </div>

    <div id="map"></div>

    <div class="list-container" id="landList">
        <p style="text-align:center; color:#666;">Loading Clan Territories...</p>
    </div>

    <div id="detailModal" class="modal">
        <div class="detail-content modal-content">
            <h2>Reinforce Territory</h2>
            <div class="detail-row"><span class="detail-lbl">Owner:</span><span class="detail-val" id="dOwner">...</span></div>
            <div class="detail-row"><span class="detail-lbl">Total Area:</span><span class="detail-val" id="dArea">...</span></div>
            <div class="detail-row"><span class="detail-lbl">Location:</span><span class="detail-val" id="dLoc" style="font-size:0.8rem; max-width:60%; text-align:right;">Fetching...</span></div>
            
            <div class="guard-section" id="guardControl">
                <span class="guard-title">üõ°Ô∏è CLAN PROTECTION</span>
                <div id="guardStatusText" style="color:#aaa; font-size:0.9rem; margin-bottom:10px;">Unprotected</div>
                
                <div id="deployUI">
                    <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">(1 Guard covers 250m¬≤ for Allies)</div>
                    
                    <div class="range-container">
                        <label>Deploy Guards: <span id="guardCountDisplay" style="color:#00bcd4; font-weight:bold; font-size:1.1rem;">1</span></label>
                        <input type="range" id="guardSlider" min="1" max="10" value="1" step="1">
                        <div class="range-labels">
                            <span>Min: 1</span>
                            <span id="maxGuardLabel">Max</span>
                        </div>
                    </div>

                    <div class="detail-row"><span class="detail-lbl">Coverage:</span><span class="detail-val" id="gCoverage" style="color:#00e676">250 m¬≤</span></div>
                    <div class="detail-row"><span class="detail-lbl">Unprotected:</span><span class="detail-val" id="gExposed" style="color:#ff4444">0 m¬≤</span></div>
                    <div class="detail-row"><span class="detail-lbl">Cost (10pts/ea):</span><span class="detail-val" id="gCost" style="color:#FFD700">10 Pts</span></div>
                    
                    <button id="btnDeploy" class="btn-deploy">DEPLOY GUARDS</button>
                </div>
                
                <div id="activeGuardUI" style="display:none; color:#00bcd4; font-weight:bold; padding:10px;">
                    ‚úÖ ALLY SECURED<br>
                    <span style="font-size:0.8rem; color:#aaa; font-weight:normal;">Expires: <span id="gExpiry"></span></span>
                </div>
            </div>

            <button class="btn-close" onclick="document.getElementById('detailModal').style.display='none'">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, get, child } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const GOOGLE_API_KEY = "AIzaSyAzfoxuzRbmyrhGChfTEWB05xvyNRmvK3k"; 
        const firebaseConfig = { databaseURL: "https://runmate-cb328-default-rtdb.firebaseio.com/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const currentUser = localStorage.getItem('currentUser');

        if (!currentUser) window.location.href = 'index.html';

        let map;
        let mapOverlays = [];
        let currentPoints = 0;
        let myClanId = null;
        let selectedLandId = null;
        let selectedLandArea = 0;

        onValue(ref(db, `users/${currentUser}`), (snap) => {
            const u = snap.val();
            if(!u) return;
            currentPoints = u.creditPoints || 0;
            myClanId = u.clan;
            document.getElementById('userPoints').innerText = currentPoints;
            if(!myClanId) {
                alert("You must be in a clan to access Clan Lands.");
                window.location.href = 'dashboard.html';
            } else {
                loadClanLands();
            }
        });

        window.initMap = function() {
            const mapEl = document.getElementById("map");
            try {
                map = new google.maps.Map(mapEl, {
                    zoom: 2, center: { lat: 20, lng: 0 }, mapTypeId: 'roadmap', disableDefaultUI: true,
                    styles: [{ featureType: "poi", elementType: "labels", stylers: [{ visibility: "off" }] }]
                });
            } catch (err) { console.error("Map Error:", err); }
        };

        function loadGoogleMaps() {
            if (document.getElementById('google-maps-script')) return; 
            const script = document.createElement('script');
            script.id = 'google-maps-script';
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_API_KEY}&libraries=geometry&callback=initMap`;
            script.async = true; script.defer = true;
            document.head.appendChild(script);
        }

        async function loadClanLands() {
            if(!myClanId) return;
            
            const clanSnap = await get(child(ref(db), `clans/${myClanId}/members`));
            const members = clanSnap.val() || {};
            
            onValue(ref(db, 'territories'), (snapshot) => {
                const data = snapshot.val();
                const list = document.getElementById('landList');
                list.innerHTML = "";
                
                mapOverlays.forEach(obj => obj.setMap(null));
                mapOverlays = [];

                let totalArea = 0;
                let bounds = new google.maps.LatLngBounds();
                let hasLands = false;

                if (data) {
                    const clanLands = Object.entries(data).filter(([k, v]) => members[v.owner]);
                    
                    if(clanLands.length === 0) {
                        list.innerHTML = "<p style='text-align:center; color:#444; margin-top:20px;'>No clan territories found.</p>";
                        return;
                    }

                    clanLands.sort((a,b) => b[1].areaSize - a[1].areaSize);

                    clanLands.forEach(([key, t]) => {
                        hasLands = true;
                        totalArea += (t.areaSize || 0);

                        // --- 1. DIFFERENTIATE COLORS ---
                        const isMine = (t.owner === currentUser);
                        const color = isMine ? '#00e676' : '#00bcd4'; // Green for me, Cyan for allies
                        const stroke = isMine ? '#004d26' : '#00838f';

                        const poly = new google.maps.Polygon({
                            paths: t.coords,
                            fillColor: color, fillOpacity: 0.4,
                            strokeColor: stroke, strokeWeight: 2,
                            map: map, clickable: true
                        });
                        
                        poly.addListener('click', () => showDetails(key, t));
                        mapOverlays.push(poly);
                        t.coords.forEach(c => bounds.extend(c));

                        let guardHtml = "";
                        const now = Date.now();
                        if (t.guarded && t.guardExpiry > now) {
                            const diff = t.guardExpiry - now;
                            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            
                            guardHtml = `<span class="guard-badge">üõ°Ô∏è ${d}d ${h}h</span>`;

                            const center = getPolygonCenter(t.coords);
                            const marker = new google.maps.Marker({
                                position: center,
                                map: map,
                                label: { text: "üõ°Ô∏è", fontSize: "16px" },
                                icon: { path: google.maps.SymbolPath.CIRCLE, scale: 0 },
                                zIndex: 100
                            });
                            mapOverlays.push(marker);
                        }

                        const itemClass = isMine ? 'mine' : 'ally';
                        const ownerDisplay = isMine ? `${t.owner} (You)` : t.owner;
                        const ownerColor = isMine ? '#00e676' : '#00bcd4';

                        const div = document.createElement('div');
                        div.className = `land-item ${itemClass}`;
                        div.innerHTML = `
                            <div class="land-info">
                                <span class="owner-name" style="color:${ownerColor}">${ownerDisplay}</span>
                                <span class="land-area">${Math.round(t.areaSize)} m¬≤ ${guardHtml}</span>
                            </div>
                            <div style="font-size:1.2rem; color:#444;">‚ùØ</div>
                        `;
                        div.onclick = () => {
                            const b = new google.maps.LatLngBounds();
                            t.coords.forEach(c => b.extend(c));
                            map.fitBounds(b);
                            showDetails(key, t);
                        };
                        list.appendChild(div);
                    });

                    if(hasLands && map) map.fitBounds(bounds);
                }
                document.getElementById('totalClanArea').innerText = Math.round(totalArea).toLocaleString();
            });
        }

        async function showDetails(key, t) {
            selectedLandId = key;
            selectedLandArea = t.areaSize || 0;

            const modal = document.getElementById('detailModal');
            modal.style.display = 'flex';
            
            document.getElementById('dOwner').innerText = t.owner;
            document.getElementById('dArea').innerText = Math.round(selectedLandArea) + " m¬≤";
            
            const isGuarded = t.guarded && (t.guardExpiry > Date.now());
            if (isGuarded) {
                document.getElementById('deployUI').style.display = 'none';
                document.getElementById('activeGuardUI').style.display = 'block';
                document.getElementById('guardStatusText').innerText = "SECURE";
                document.getElementById('guardStatusText').style.color = "#00bcd4";
                document.getElementById('gExpiry').innerText = new Date(t.guardExpiry).toLocaleDateString();
            } else {
                document.getElementById('deployUI').style.display = 'block';
                document.getElementById('activeGuardUI').style.display = 'none';
                document.getElementById('guardStatusText').innerText = "VULNERABLE";
                document.getElementById('guardStatusText').style.color = "#ff4444";

                // --- 2. FLEXIBLE GUARD DEPLOYMENT ---
                // Rule: 1 Guard covers 250m¬≤ for allies
                const maxGuardsNeeded = Math.ceil(selectedLandArea / 250);
                
                const slider = document.getElementById('guardSlider');
                slider.max = maxGuardsNeeded;
                slider.value = maxGuardsNeeded; // Default to full coverage
                document.getElementById('maxGuardLabel').innerText = "Max: " + maxGuardsNeeded;

                // Initialize Update
                updateDeployCalc(maxGuardsNeeded);

                // Listener for changes
                slider.oninput = function() {
                    updateDeployCalc(this.value);
                };
            }

            const center = getPolygonCenter(t.coords);
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${center.lat}&lon=${center.lng}`);
                const data = await response.json();
                const addr = data.address;
                const locName = addr.road || addr.suburb || addr.city || "Unknown Location";
                document.getElementById('dLoc').innerText = locName;
            } catch (e) { document.getElementById('dLoc').innerText = "Unknown Location"; }
        }

        function updateDeployCalc(count) {
            const guardedArea = count * 250;
            const exposed = Math.max(0, selectedLandArea - guardedArea);
            const cost = count * 10;

            document.getElementById('guardCountDisplay').innerText = count;
            document.getElementById('gCoverage').innerText = Math.round(Math.min(guardedArea, selectedLandArea)) + " m¬≤";
            document.getElementById('gExposed').innerText = Math.round(exposed) + " m¬≤";
            document.getElementById('gCost').innerText = cost + " Pts";

            const btn = document.getElementById('btnDeploy');
            btn.onclick = () => deployGuards(count, cost); // Bind with current values

            if (currentPoints < cost) {
                btn.disabled = true;
                btn.innerText = "NOT ENOUGH POINTS";
                btn.style.background = "#444";
            } else {
                btn.disabled = false;
                btn.innerText = `DEPLOY (${cost} PTS)`;
                btn.style.background = "#00bcd4";
            }
        }

        async function deployGuards(count, cost) {
            if(!selectedLandId) return;

            if(currentPoints < cost) return alert("Insufficient Credit Points!");

            // Calculate percentage coverage for confirmation msg
            const coveragePct = Math.min(100, Math.round((count * 250 / selectedLandArea) * 100));

            if(!confirm(`Deploy ${count} Guards?\nCost: ${cost} Pts.\nCoverage: ${coveragePct}% of territory.`)) return;

            const updates = {};
            updates[`territories/${selectedLandId}/guarded`] = true;
            updates[`territories/${selectedLandId}/guardCount`] = parseInt(count); // Save specific count
            updates[`territories/${selectedLandId}/guardExpiry`] = Date.now() + (7 * 24 * 60 * 60 * 1000); 
            updates[`users/${currentUser}/creditPoints`] = currentPoints - cost;

            try {
                await update(ref(db), updates);
                alert("Guards Deployed! Territory reinforced.");
                document.getElementById('detailModal').style.display = 'none';
            } catch(e) {
                alert("Error: " + e.message);
            }
        }

        function getPolygonCenter(coords) {
            let lat = 0, lng = 0;
            coords.forEach(c => { lat += c.lat; lng += c.lng; });
            return { lat: lat / coords.length, lng: lng / coords.length };
        }

        loadGoogleMaps();
    </script>
</body>
</html>
