<!DOCTYPE html>
<html lang="en">
<head>
    <title>Clan Stronghold</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: #e0e0e0; margin: 0; padding: 0; min-height: 100vh; }
        
        .header { background: linear-gradient(180deg, #2b0000 0%, #111 100%); padding: 30px 20px; text-align: center; border-bottom: 2px solid #8B0000; position: relative; }
        h1 { margin: 0; font-family: 'Cinzel', serif; color: #ff4444; font-size: 2rem; letter-spacing: 2px; }
        .leader-badge { background: #FFD700; color: black; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8rem; text-transform: uppercase; }
        .logout-btn-header { position: absolute; top: 20px; right: 20px; background: none; border: 1px solid #ff4444; color: #ff4444; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
        
        .tabs { display: flex; justify-content: center; background: #111; border-bottom: 1px solid #333; }
        .tab-btn { padding: 15px 25px; background: none; border: none; color: #888; cursor: pointer; font-weight: bold; font-family: 'Cinzel', serif; font-size: 1rem; flex: 1; max-width: 150px; }
        .tab-btn.active { color: #C5A059; border-bottom: 3px solid #C5A059; background: #1a1a1a; }
        
        .container { max-width: 600px; margin: 20px auto; padding: 0 15px; }
        .section { display: none; animation: fadein 0.3s; }
        .section.active { display: block; }
        @keyframes fadein { from {opacity:0} to {opacity:1} }
        
        .list-item { background: #1a1a1a; padding: 15px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #333; }
        .user-row { display: flex; align-items: center; gap: 10px; }
        .recruit-info { display: flex; flex-direction: column; }
        .recruit-name { font-weight: bold; color: #C5A059; font-size: 1rem; }
        .recruit-stats { font-size: 0.75rem; color: #aaa; margin-top: 3px; }
        
        .btn-kick { background: none; border: 1px solid #444; color: #ff4444; padding: 5px 10px; cursor: pointer; border-radius: 4px; font-size: 0.8rem; }
        .btn-accept { background: #00e676; color: black; border: none; padding: 8px 15px; font-weight: bold; border-radius: 4px; cursor: pointer; }
        .btn-invite { background: #C5A059; color: black; border: none; padding: 8px 15px; font-weight: bold; border-radius: 4px; cursor: pointer; transition: 0.2s; }
        .btn-invite:disabled { background: #333; color: #666; cursor: default; }
        .btn-refresh { display: block; margin: 0 auto 20px auto; background: #333; color: white; border: 1px solid #555; padding: 8px 15px; cursor: pointer; border-radius: 20px; font-size: 0.8rem; }
        
        .back-link { display: block; text-align: center; margin: 20px; color: #888; text-decoration: none; }
    </style>
</head>
<body>
    <div class="header">
        <button class="logout-btn-header" onclick="window.logout()">LOGOUT</button>
        <h1 id="clanNameTitle">Loading...</h1>
        <div id="roleDisplay" style="margin-top:10px; color:#aaa;"></div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="window.switchTab('members')">Warriors</button>
        <button class="tab-btn" onclick="window.switchTab('requests')" id="reqTabBtn">Requests</button>
        <button class="tab-btn" onclick="window.switchTab('recruit')" id="recTabBtn">Recruit</button>
    </div>

    <div class="container">
        <div id="members" class="section active">
            <h3 style="color:#C5A059; border-bottom:1px solid #333; padding-bottom:10px;">Clan Roster (<span id="countDisplay">0</span>/15)</h3>
            <div id="membersList"></div>
            <button onclick="window.leaveClan()" style="width:100%; padding:15px; background:#111; border:1px solid #333; color:#ff4444; margin-top:20px; cursor:pointer;">Abandon Clan</button>
        </div>

        <div id="requests" class="section">
            <h3 style="color:#C5A059;">Pending Applications</h3>
            <div id="requestsList"></div>
        </div>

        <div id="recruit" class="section">
            <h3 style="color:#C5A059; text-align:center;">Scout for Warriors</h3>
            <button class="btn-refresh" onclick="window.forceReloadRecruits()">üîÑ Refresh List</button>
            <div id="recruitList"><p style="text-align:center; color:#666;">Click Refresh to scan global registry.</p></div>
        </div>
    </div>

    <a href="dashboard.html" class="back-link">‚Üê Return to Dashboard</a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, update, onValue, get, child, set } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { databaseURL: "https://runmate-cb328-default-rtdb.firebaseio.com/" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const currentUser = localStorage.getItem('currentUser');

        if (!currentUser) window.location.href = 'index.html';

        let myClanId = null, isLeader = false, recruitCache = null;

        // --- GLOBAL WINDOW FUNCTIONS ---
        window.logout = function() { if(confirm("Logout?")) { localStorage.clear(); window.location.href = 'index.html'; }};

        window.inviteUser = async (targetId) => {
            if(!confirm(`Invite ${targetId} to the clan?`)) return;
            try {
                // Use SET for single value update
                await set(ref(db, `users/${targetId}/invites/${myClanId}`), true);
                alert(`Invitation sent to ${targetId}!`);
            } catch(e) { alert("Error sending invite: " + e.message); }
        };

        window.kickMember = async (t) => { if(confirm("Exile?")) await update(ref(db), {[`clans/${myClanId}/members/${t}`]: null, [`users/${t}/clan`]: null}); };
        
        window.approveRequest = async (t) => { 
            const s = await get(child(ref(db), `clans/${myClanId}/members`));
            if(Object.keys(s.val()||{}).length >= 15) return alert("Full!");
            await update(ref(db), {[`clans/${myClanId}/requests/${t}`]: null, [`clans/${myClanId}/members/${t}`]: true, [`users/${t}/clan`]: myClanId, [`users/${t}/pendingClan`]: null});
        };
        
        window.rejectRequest = async (t) => { await update(ref(db), {[`clans/${myClanId}/requests/${t}`]: null, [`users/${t}/pendingClan`]: null}); };
        
        window.leaveClan = async () => { if(isLeader){alert("Leaders cannot leave.");return;} if(confirm("Leave?")) { await update(ref(db), {[`clans/${myClanId}/members/${currentUser}`]: null, [`users/${currentUser}/clan`]: null}); window.location.href='dashboard.html'; }};

        window.switchTab = (tabId) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            if(tabId === 'members') document.querySelector('button[onclick="window.switchTab(\'members\')"]').classList.add('active');
            if(tabId === 'requests') document.getElementById('reqTabBtn').classList.add('active');
            if(tabId === 'recruit') { document.getElementById('recTabBtn').classList.add('active'); if(!recruitCache) loadRecruitmentList(); }
        };
        
        window.forceReloadRecruits = () => { recruitCache = null; loadRecruitmentList(); };

        // --- DATABASE LOGIC ---
        onValue(ref(db, `users/${currentUser}`), (snapshot) => {
            const user = snapshot.val();
            if (!user || !user.clan) { window.location.href = 'dashboard.html'; return; }
            if(myClanId !== user.clan) { myClanId = user.clan; loadClanData(myClanId); }
        });

        function loadClanData(clanId) {
            onValue(ref(db, `clans/${clanId}`), (snapshot) => {
                const clan = snapshot.val();
                if(!clan) return;
                isLeader = (clan.leader === currentUser);
                
                document.getElementById('clanNameTitle').innerText = clanId;
                document.getElementById('roleDisplay').innerHTML = isLeader ? '<span class="leader-badge">CLAN LEADER</span>' : 'Soldier';
                
                document.getElementById('reqTabBtn').style.display = isLeader ? 'block' : 'none';
                document.getElementById('recTabBtn').style.display = isLeader ? 'block' : 'none';

                renderMembers(clan.members, clan.leader);
                if(isLeader) renderRequests(clan.requests);
            });
        }

        function renderMembers(membersObj, leaderName) {
            const list = document.getElementById('membersList');
            const members = Object.keys(membersObj || {});
            document.getElementById('countDisplay').innerText = members.length;
            list.innerHTML = members.map(uid => {
                const isMe = (uid === currentUser), isTargetLeader = (uid === leaderName);
                let actionBtn = (isLeader && !isMe) ? `<button class="btn-kick" onclick="window.kickMember('${uid}')">KICK</button>` : '';
                return `<div class="list-item"><div class="user-row"><div style="font-weight:bold; color:${isTargetLeader ? '#FFD700' : 'white'}">${uid}</div>${isTargetLeader ? '<span class="leader-badge">‚òÖ</span>' : ''}</div>${actionBtn}</div>`;
            }).join('');
        }

        function renderRequests(reqObj) {
            const list = document.getElementById('requestsList');
            const requests = Object.keys(reqObj || {});
            if(!requests.length) { list.innerHTML = "<p style='color:#444; text-align:center;'>No pending requests.</p>"; return; }
            list.innerHTML = requests.map(uid => `
                <div class="list-item"><span>${uid}</span><div style="display:flex; gap:10px;"><button class="btn-accept" onclick="window.approveRequest('${uid}')">Accept</button><button class="btn-kick" onclick="window.rejectRequest('${uid}')">Reject</button></div></div>
            `).join('');
        }

        function loadRecruitmentList() {
            const list = document.getElementById('recruitList');
            if (recruitCache) { renderRecruitList(recruitCache); return; }
            list.innerHTML = "<p style='color:#C5A059; text-align:center;'>Scanning global database...</p>";
            
            Promise.all([get(ref(db, 'users')), get(ref(db, 'territories'))]).then(([usersSnap, terrSnap]) => {
                const allUsers = usersSnap.val() || {}, allTerr = terrSnap.val() || {};
                const userStats = {};
                
                Object.keys(allUsers).forEach(uid => userStats[uid] = { area: 0, count: 0 });
                Object.values(allTerr).forEach(t => { if(t.owner && userStats[t.owner]){ userStats[t.owner].area += (t.areaSize||0); userStats[t.owner].count++; }});
                
                const nomads = Object.keys(allUsers).filter(uid => !allUsers[uid].clan && uid !== currentUser).sort((a,b) => userStats[b].area - userStats[a].area);
                recruitCache = { nomads, userStats, allUsers };
                renderRecruitList(recruitCache);
            });
        }

        function renderRecruitList(data) {
            const list = document.getElementById('recruitList');
            const { nomads, userStats, allUsers } = data;
            if(!nomads.length) { list.innerHTML = "<p style='color:#666; text-align:center;'>No wandering nomads found.</p>"; return; }
            list.innerHTML = "";
            nomads.forEach(uid => {
                const hasInvite = allUsers[uid].invites && allUsers[uid].invites[myClanId];
                const stats = userStats[uid];
                list.innerHTML += `<div class="list-item"><div class="recruit-info"><div class="recruit-name">${uid}</div><div class="recruit-stats">‚öîÔ∏è ${stats.count} Lands | üó∫Ô∏è ${Math.round(stats.area).toLocaleString()} m¬≤</div></div><button class="btn-invite" onclick="window.inviteUser('${uid}')" ${hasInvite ? 'disabled' : ''}>${hasInvite ? 'Sent' : 'Recruit'}</button></div>`;
            });
        }
    </script>
</body>
</html>